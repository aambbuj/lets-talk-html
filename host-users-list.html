<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Users (Host View)</title>
  <script src="js/config.js"></script>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <style>
    body { margin:0; font-family: 'Segoe UI', sans-serif; background:linear-gradient(to bottom, #f8c6d8, #fddae3); }
    .container { max-width:440px; margin:0 auto; padding:16px; }
    .header { font-size:22px; font-weight:800; color:#fff; padding:14px; text-align:center; background:#d6006d; border-radius:12px; }
    .search { margin:12px 0; }
    .search input { width:100%; padding:12px; border:1px solid #ffd4e6; border-radius:12px; background:#fff; }
    .list { display:flex; flex-direction:column; gap:12px; }
    .card { display:flex; gap:12px; padding:12px; background:#fff; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); align-items:center; }
    .card img { width:64px; height:64px; border-radius:10px; object-fit:cover; }
    .info { flex:1; }
    .name { font-weight:700; color:#0f172a; }
    .meta { font-size:12px; color:#475569; }
    .status { font-size:12px; color:#475569; margin-top:4px; }
    .dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; background:#9ca3af; }
    .dot.online { background:#22c55e; }
    .actions { display:flex; gap:8px; }
    .btn { background:#d6006d; color:#fff; border:none; padding:8px 12px; border-radius:18px; cursor:pointer; font-size:12px; }
  </style>
  <script>
    let allUsers = [];
    let me = { id: null, profileId: null, name: null };
    let online = new Set();
    let socket;

    async function startCall(user){
      try {
        const callerId = Number(me.id || localStorage.getItem('userId'));
        const calleeId = Number(user.id);
        const roomResp = await fetch(API_CONFIG.getAuthUrl('/room/create'), { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ callerId, calleeId }) });
        const roomData = await roomResp.json();
        const roomName = roomData?.data?.name || `room_${Math.min(callerId,calleeId)}_${Math.max(callerId,calleeId)}`;
        window.location.href = `room-video.html?room=${encodeURIComponent(roomName)}&name=${encodeURIComponent(me.name||'Me')}&peer=${encodeURIComponent(user.name||'User')}`;
      } catch(_){
        const callerId = Number(me.id || localStorage.getItem('userId'));
        const calleeId = Number(user.id);
        const a = Math.min(callerId, calleeId), b = Math.max(callerId, calleeId);
        const fallback = (Number.isFinite(a)&&Number.isFinite(b))?`room_${a}_${b}`:`room_${user.user_profile_id||user.id}`;
        window.location.href = `room-video.html?room=${encodeURIComponent(fallback)}&name=${encodeURIComponent(me.name||'Me')}&peer=${encodeURIComponent(user.name||'User')}`;
      }
    }

    async function startChat(user){
      try {
        const callerId = Number(me.id || localStorage.getItem('userId'));
        const calleeId = Number(user.id);
        let roomName = '';
        try {
          const roomResp = await fetch(API_CONFIG.getAuthUrl('/room/create'), {
            method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ callerId, calleeId })
          });
          const roomData = await roomResp.json();
          roomName = (roomData && roomData.data && typeof roomData.data.name === 'string') ? roomData.data.name : '';
        } catch(_) {}
        if (!roomName) {
          const a = Math.min(callerId, calleeId), b = Math.max(callerId, calleeId);
          roomName = (Number.isFinite(a) && Number.isFinite(b)) ? `room_${a}_${b}` : `room_${user.user_profile_id||user.id}`;
        }
        try {
          if (socket && me.profileId && user.user_profile_id) {
            socket.emit('chat-invite', { from: String(me.profileId), fromName: me.name, to: String(user.user_profile_id), roomName });
          }
        } catch(_){}
        window.location.href = `room-chat.html?room=${encodeURIComponent(roomName)}&name=${encodeURIComponent(me.name||'Me')}&peer=${encodeURIComponent(user.name||'User')}&mode=chat`;
      } catch(_){
        const callerId = Number(me.id || localStorage.getItem('userId'));
        const calleeId = Number(user.id);
        const a = Math.min(callerId, calleeId), b = Math.max(callerId, calleeId);
        const fallback = (Number.isFinite(a)&&Number.isFinite(b))?`room_${a}_${b}`:`room_${user.user_profile_id||user.id}`;
        window.location.href = `room-chat.html?room=${encodeURIComponent(fallback)}&name=${encodeURIComponent(me.name||'Me')}&peer=${encodeURIComponent(user.name||'User')}&mode=chat`;
      }
    }

    function render(list) {
      const root = document.getElementById('list');
      root.innerHTML = '';
      if (!list || list.length===0) { root.innerHTML = '<p style="text-align:center;color:#475569;">No users found.</p>'; return; }
      list.forEach(u => {
        const img = (u.Images && u.Images.length>0 && u.Images[0].url) ? u.Images[0].url : 'imgs/logo11.png';
        const el = document.createElement('div');
        el.className = 'card';
        const onlineDot = online.has(String(u.user_profile_id||'')) ? 'online' : '';
        el.innerHTML = `
          <img src="${img}" alt="${u.name||'User'}"/>
          <div class="info">
            <div class="name">${u.name||'User'}</div>
            <div class="meta">${u.email||''}</div>
            <div class="status"><span class="dot ${onlineDot}"></span>${onlineDot?'Online':'Offline'}</div>
          </div>
          <div class="actions">
            <button class="btn" onclick='startCall(${JSON.stringify(u)})'>Call</button>
            <button class="btn" onclick='startChat(${JSON.stringify(u)})'>Chat</button>
          </div>`;
        root.appendChild(el);
      });
    }

    async function loadUsers() {
      const token = localStorage.getItem('authToken') || localStorage.getItem('userToken');
      if (!token) { window.location.href='User/userlogin.html'; return; }
      try {
        const myRes = await fetch(API_CONFIG.getAuthUrl('/show-profile'), { headers: { 'Authorization': `Bearer ${token}` } });
        const myData = await myRes.json();
        if (myRes.ok && myData?.data) { me.id = myData.data.id; me.profileId = myData.data.user_profile_id; me.name = myData.data.name; }
      } catch(_){ }
      const res = await fetch(API_CONFIG.getAuthUrl('/user-list-for-host'), { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      allUsers = data?.data || [];
      render(allUsers);
      // Initialize presence via socket if available
      try {
        socket = io(API_CONFIG.getBaseUrl(), { path:'/socket.io' });
        if (me.profileId) {
          socket.emit('register', me.profileId, String(me.id||''));
        }
        // Online presence list
        socket.on('user-list', (names) => {
          try {
            online = new Set((names||[]).map(x => String(x)));
            render(allUsers);
          } catch(_){}
        });
        // Incoming chat invites
        socket.on('incoming-chat', ({ from, fromName, roomName }) => {
          const accept = confirm(`${fromName || from} invited you to chat. Join?`);
          if (accept) {
            window.location.href = `room-chat.html?room=${encodeURIComponent(roomName)}&name=${encodeURIComponent(me.name||'Me')}&peer=${encodeURIComponent(fromName||'User')}&mode=chat`;
          }
        });
      } catch(_){ }
    }
    
    function onSearch(v){ const q=(v||'').toLowerCase(); if(!q) return render(allUsers); render(allUsers.filter(u=> (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q))); }
    document.addEventListener('DOMContentLoaded', loadUsers);
  </script>
</head>
<body>
  <div class="header">Users (Host View)</div>
  <div class="container">
    <div class="search"><input placeholder="Search user..." oninput="onSearch(this.value)"/></div>
    <div id="list" class="list"></div>
  </div>
</body>
</html>


