<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Users</title>
  <link rel="icon" href="/assets/imgs/favicon.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="js/config.js"></script>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script src="js/incoming-call.js"></script>
  <script src="js/outgoing-call.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom, #f8c6d8, #fddae3);
    }

    .container {
      max-width: 440px;
      margin: 0 auto;
      padding: 16px;
    }

    .header {
      font-size: 22px;
      font-weight: 800;
      color: #fff;
      padding: 14px;
      text-align: center;
      background: #d6006d;
      border-radius: 12px;
    }

    .search {
      margin: 12px 0;
    }

    .search input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ffd4e6;
      border-radius: 12px;
      background: #fff;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      display: flex;
      gap: 9px;
      padding: 12px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      align-items: center;
    }

    .card img {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      object-fit: cover;
    }

    .info {
      flex: 1;
    }

    .name {
      font-weight: 700;
      color: #0f172a;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status {
      font-size: 12px;
      color: #475569;
      margin-top: 4px;
    }

    .dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      background: #9ca3af;
    }

    .dot.online {
      background: #22c55e;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      background: #d6006d;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 12px;
    }

    .badge {
      background: #ef4444;
      color: #fff;
      border-radius: 12px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 700;
      line-height: 1;
    }

    a {
      text-decoration: none;
    }
  </style>
</head>

<body>
  <div class="header">Users</div>
  <div class="container">
    <div class="search"><input placeholder="Search user..." oninput="onSearch(this.value)" /></div>
    <div id="list" class="list"></div>
  </div>

  <script>
    let allUsers = [];
    let me = {};
    let onlineUsers = new Set();
    let socket;
    let unreadCounts = {};

    function storageKey() { return `unreadCounts_${String(me.user_profile_id || '')}`; }
    function loadUnread() { try { unreadCounts = JSON.parse(localStorage.getItem(storageKey()) || '{}'); } catch (e) { unreadCounts = {}; } }
    function saveUnread() { localStorage.setItem(storageKey(), JSON.stringify(unreadCounts)); }

    // MODIFICATION START: Replaced the old startCall function with the new version.
    // This version uses the `outgoing-call.js` helper to show a popup and wait for a response.
    async function startCall(user) {
      try {
        const token = localStorage.getItem('authToken');
        const roomResp = await fetch(API_CONFIG.getAuthUrl('/room/create'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ sender_id: me.id, receiver_id: user.id })
        });
        const roomData = await roomResp.json();
        if (!roomResp.ok) throw new Error("Failed to create room");

        if (window.outgoingCall) {
          // Pass the full user object (for name/avatar) and the room name to the helper.
          window.outgoingCall.startOutgoingCall(user, roomData.data.name);
          // The 'return' is critical. It stops this function from navigating immediately.
          return;
        }
      } catch (err) {
        console.error("Error starting call:", err);
        alert("Could not start the call.");
      }
    }
    // MODIFICATION END

    async function startChat(user) {
      try {
        const token = localStorage.getItem('authToken');
        const roomResp = await fetch(API_CONFIG.getAuthUrl('/room/create'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ sender_id: me.id, receiver_id: Number(user.id) })
        });
        const roomData = await roomResp.json();
        let roomName = roomData?.data?.name || `room_${Math.min(me.id, user.id)}_${Math.max(me.id, user.id)}`;

        if (socket) {
          socket.emit('chat-invite', { from: me.user_profile_id, fromName: me.name, to: String(user.user_profile_id), roomName });
        }

        unreadCounts[String(user.user_profile_id || '')] = 0;
        saveUnread();
        window.location.href = `room-chat.html?room=${encodeURIComponent(roomName)}&name=${encodeURIComponent(me.name || 'Me')}&peer=${encodeURIComponent(user.name || 'User')}`;
      } catch (e) {
        alert("Could not start chat.");
      }
    }

    // MODIFICATION START: Replaced the old socket logic with a reliable version.
    // This connects and then registers the user, fixing the "User not found" error.
    function initSocket() {
      if (socket) return;
      const SOCKET_URL = API_CONFIG.getBaseUrl();
      socket = io(SOCKET_URL, { path: '/socket.io' });
      window.socket = socket; // Make it globally available for helper scripts

      socket.on('connect', () => {
        console.log(`Socket connected on Host page with ID: ${socket.id}`);
        // Register this user with the server as soon as connection is established.
        if (me.user_profile_id) {
          socket.emit('register', me.user_profile_id, me.id);
        }
      });

      socket.on('user-list', (userList) => {
        onlineUsers = new Set(userList || []);
        render(allUsers); // Re-render to show online status changes.
      });

      socket.on('incoming-chat', ({ from }) => {
        const key = String(from || '');
        if (key) {
          unreadCounts[key] = (unreadCounts[key] || 0) + 1;
          saveUnread();
          render(allUsers);
        }
      });
    }
    // MODIFICATION END

    async function loadPage() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }
      try {
        const myRes = await fetch(API_CONFIG.getAuthUrl('/show-profile'), { headers: { 'Authorization': `Bearer ${token}` } });
        const myData = await myRes.json();
        if (!myRes.ok) throw new Error("Could not fetch host profile");

        me = myData.data;
        window.MY_USERNAME = me.user_profile_id;
        window.MY_USER_ID = me.id;

        initSocket();
        loadUnread();

        const res = await fetch(API_CONFIG.getAuthUrl('/user-list-for-host'), { headers: { "Authorization": `Bearer ${token}` } });
        const data = await res.json();
        if (!res.ok) throw new Error("Could not fetch users");
        allUsers = data.data || [];
        render(allUsers);
      } catch (err) {
        console.error("Error loading page:", err);
      }
    }

    function render(list) {
      const root = document.getElementById('list');
      root.innerHTML = '';
      if (!list || !list.length) {
        root.innerHTML = '<p style="text-align:center;color:#475569;">No users found.</p>';
        return;
      }
      list.forEach(u => {
        const img = u.Images?.find(img => img.image_type === 'profile_photo')?.url || 'imgs/logo11.png';
        const isOnline = onlineUsers.has(u.user_profile_id);
        const unread = unreadCounts[String(u.user_profile_id || '')] || 0;

        const cardWrapper = document.createElement('div');
        cardWrapper.innerHTML = `
                    <div class="card">
                        <img src="${img}" alt="${u.name || 'User'}"/>
                        <div class="info">
                            <div class="name">${u.name || 'User'} ${unread > 0 ? `<span class="badge">${unread}</span>` : ''}</div>
                            <div class="status">
                                <span class="dot ${isOnline ? 'online' : ''}"></span>
                                ${isOnline ? 'Online' : 'Offline'}
                            </div>
                        </div>
                        <div class="actions">
                            <button class="btn" data-action="call">Call</button>
                            <button class="btn" data-action="chat">Chat</button>
                        </div>
                    </div>`;

        const cardElement = cardWrapper.firstElementChild;
        cardElement.querySelector('[data-action="call"]').addEventListener('click', () => startCall(u));
        cardElement.querySelector('[data-action="chat"]').addEventListener('click', () => startChat(u));
        root.appendChild(cardElement);
      });
    }

    function onSearch(v) {
      const query = (v || '').toLowerCase().trim();
      render(query ? allUsers.filter(u => (u.name || '').toLowerCase().includes(query)) : allUsers);
    }

    document.addEventListener('DOMContentLoaded', loadPage);
  </script>
</body>

</html>